<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wide to Long Format Converter</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; padding: 20px; background-color: #f0f4f8; font-family: 'Oswald', Arial, sans-serif; color: #000000; font-weight: 500; min-height: 100vh; }
        
        .page-container { width: 100%; max-width: 1200px; margin: 0 auto; }
        
        .page-header { background-color: #004080; color: #ffffff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .logo-box { background: #ffffff; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; }
        .logo-box img { width: 80px; height: auto; border-radius: 6px; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; font-weight: 500; }
        
        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }
        
        .section-header { background-color: #004080; color: #ffffff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #ffffff; color: #004080; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; }
        .section-title { font-size: 16px; font-weight: 700; letter-spacing: 0.5px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: #004080; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-family: 'Oswald', Arial, sans-serif; font-weight: 500; color: #000; background: #ffffff; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .help-text { font-size: 12px; color: #666; margin-top: 5px; font-style: italic; }
        
        .btn-primary { padding: 14px 24px; background: #004080; color: #ffffff; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-primary:hover { background: #0056b3; border-color: #0056b3; }
        .btn-primary:disabled { background: #6c757d; border-color: #6c757d; cursor: not-allowed; }
        .btn-gold { padding: 14px 24px; background: #ffc107; color: #000000; border: 2px solid #ffc107; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all 0.3s; }
        .btn-gold:hover { background: #e0a800; border-color: #e0a800; }
        .btn-gold:disabled { background: #ccc; color: #666; border-color: #ccc; cursor: not-allowed; }
        
        .upload-zone { border: 3px dashed #004080; border-radius: 8px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { background: #e7f3ff; border-color: #0056b3; }
        .upload-zone.dragover { background: #d4edda; border-color: #28a745; }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-text { font-size: 16px; color: #004080; font-weight: 600; }
        .upload-hint { font-size: 12px; color: #666; margin-top: 8px; }
        
        .file-info { background: #d4edda; border: 2px solid #28a745; border-radius: 6px; padding: 15px; margin-top: 15px; display: none; }
        .file-info.show { display: block; }
        .file-name { font-weight: 700; color: #155724; }
        .file-details { font-size: 12px; color: #155724; margin-top: 5px; }
        
        .columns-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .column-panel { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; overflow: hidden; }
        .panel-header { background: #004080; color: white; padding: 12px 15px; font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .panel-count { background: #ffffff; color: #004080; padding: 2px 10px; border-radius: 12px; font-size: 11px; }
        .panel-content { max-height: 250px; overflow-y: auto; padding: 10px; }
        .column-item { padding: 8px 12px; margin: 4px 0; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .column-item:hover { background: #e7f3ff; border-color: #004080; }
        .column-item.selected { background: #d4edda; border-color: #28a745; }
        .column-item input { accent-color: #004080; }
        .panel-actions { padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        .panel-btn { flex: 1; padding: 8px; border: 1px solid #004080; background: white; color: #004080; border-radius: 4px; font-family: 'Oswald', Arial, sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; }
        .panel-btn:hover { background: #004080; color: white; }
        .panel-btn.danger { border-color: #dc3545; color: #dc3545; }
        .panel-btn.danger:hover { background: #dc3545; color: white; }
        
        .pattern-config { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .pattern-example { background: #1a1a2e; color: #17a2b8; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; margin: 15px 0; }
        .pattern-example .highlight { color: #ffc107; font-weight: bold; }
        .pattern-example .arrow { color: #28a745; }
        
        .preview-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .preview-table th { background: #004080; color: white; padding: 10px 8px; text-align: left; font-weight: 600; }
        .preview-table td { padding: 8px; border-bottom: 1px solid #ddd; }
        .preview-table tr:nth-child(even) { background: #f8f9fa; }
        .preview-table tr:hover { background: #e7f3ff; }
        .new-col { background: #d4edda !important; }
        
        .result-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: 700; color: #004080; }
        .stat-label { font-size: 12px; color: #666; margin-top: 5px; text-transform: uppercase; }
        
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 8px; font-weight: 600; z-index: 2000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .notification.success { background: #d4edda; color: #155724; border: 2px solid #28a745; display: block; }
        .notification.error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; display: block; }
        .notification.info { background: #e7f3ff; color: #004080; border: 2px solid #004080; display: block; }
        
        .page-footer { background-color: #004080; color: #ffffff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; font-weight: 500; border-radius: 0 0 8px 8px; }
        .page-footer p { margin: 6px 0 0; font-size: 12px; }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .columns-container, .form-row, .result-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="logo-row">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
                </div>
            </div>
            <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
            <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
            <h1>WIDE TO LONG FORMAT CONVERTER</h1>
            <p class="subtitle">Transform Wide Column Names into Separate Variables</p>
        </div>

        <div class="content-card">
            <div class="content-inner">
                <!-- Step 1: Upload -->
                <div class="section-header">
                    <span class="section-icon">1</span>
                    <span class="section-title">UPLOAD DATA FILE</span>
                </div>
                
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Click or drag file here to upload</div>
                    <div class="upload-hint">Supports CSV and Excel files (.csv, .xlsx, .xls)</div>
                </div>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                
                <div class="file-info" id="fileInfo">
                    <span class="file-name" id="fileName"></span>
                    <div class="file-details" id="fileDetails"></div>
                </div>

                <!-- Step 2: Select Columns -->
                <div class="section-header hidden" id="step2Header" style="margin-top: 30px;">
                    <span class="section-icon">2</span>
                    <span class="section-title">SELECT COLUMNS TO UNPIVOT</span>
                </div>
                
                <div class="hidden" id="step2Content">
                    <p style="color: #666; margin-bottom: 15px;">Select the columns that contain the pattern you want to split (e.g., pop_2023, pop_2024). ID columns will be kept as-is.</p>
                    
                    <div class="columns-container">
                        <div class="column-panel">
                            <div class="panel-header">
                                ID Columns (Keep As-Is)
                                <span class="panel-count" id="idCount">0</span>
                            </div>
                            <div class="panel-content" id="idColumnsPanel"></div>
                            <div class="panel-actions">
                                <button class="panel-btn" onclick="selectAllId()">Select All</button>
                                <button class="panel-btn danger" onclick="clearAllId()">Clear All</button>
                            </div>
                        </div>
                        
                        <div class="column-panel">
                            <div class="panel-header">
                                Value Columns (To Unpivot)
                                <span class="panel-count" id="valueCount">0</span>
                            </div>
                            <div class="panel-content" id="valueColumnsPanel"></div>
                            <div class="panel-actions">
                                <button class="panel-btn" onclick="selectAllValue()">Select All</button>
                                <button class="panel-btn danger" onclick="clearAllValue()">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Define Pattern -->
                <div class="section-header hidden" id="step3Header" style="margin-top: 30px;">
                    <span class="section-icon">3</span>
                    <span class="section-title">DEFINE COLUMN NAME PATTERN</span>
                </div>
                
                <div class="hidden" id="step3Content">
                    <div class="pattern-config">
                        <div class="form-group">
                            <label class="form-label">Separator Type</label>
                            <select class="form-select" id="separatorType" onchange="updatePatternPreview()">
                                <option value="_">Underscore ( _ ) - e.g., pop_2023</option>
                                <option value="-">Dash ( - ) - e.g., pop-2023</option>
                                <option value=".">Dot ( . ) - e.g., pop.2023</option>
                                <option value="number">No separator (split at number) - e.g., pop2023</option>
                                <option value="custom">Custom separator</option>
                            </select>
                        </div>
                        
                        <div class="form-group hidden" id="customSepGroup">
                            <label class="form-label">Custom Separator</label>
                            <input type="text" class="form-input" id="customSeparator" placeholder="Enter separator" oninput="updatePatternPreview()">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">First Part Column Name</label>
                                <input type="text" class="form-input" id="firstPartName" value="indicator" placeholder="e.g., indicator, variable" oninput="updatePatternPreview()">
                                <div class="help-text">Name for the part before separator (e.g., "pop")</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Second Part Column Name</label>
                                <input type="text" class="form-input" id="secondPartName" value="year" placeholder="e.g., year, period" oninput="updatePatternPreview()">
                                <div class="help-text">Name for the part after separator (e.g., "2023")</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Value Column Name</label>
                            <input type="text" class="form-input" id="valueColName" value="value" placeholder="e.g., value, population" oninput="updatePatternPreview()">
                            <div class="help-text">Name for the column containing the actual data values</div>
                        </div>
                        
                        <div class="pattern-example" id="patternExample">
                            <strong>Example transformation:</strong><br><br>
                            Column: <span class="highlight">pop_2023</span> <span class="arrow">‚Üí</span> 
                            <span class="highlight">indicator</span>: pop, <span class="highlight">year</span>: 2023, <span class="highlight">value</span>: [data]
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn-primary" onclick="previewConversion()">Preview Conversion</button>
                    </div>
                </div>

                <!-- Step 4: Preview & Download -->
                <div class="section-header hidden" id="step4Header" style="margin-top: 30px;">
                    <span class="section-icon">4</span>
                    <span class="section-title">PREVIEW & DOWNLOAD</span>
                </div>
                
                <div class="hidden" id="step4Content">
                    <div class="result-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="statRows">0</div>
                            <div class="stat-label">Output Rows</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statCols">0</div>
                            <div class="stat-label">Output Columns</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statExpansion">0x</div>
                            <div class="stat-label">Row Expansion</div>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="preview-table" id="previewTable"></table>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                        <button class="btn-gold" onclick="downloadResult('csv')">Download CSV</button>
                        <button class="btn-gold" onclick="downloadResult('xlsx')">Download Excel</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-footer">
            <p style="margin: 0; font-weight: 700;">Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
            <p>Driving Data-Driven Solutions for Health and Development</p>
            <p style="font-size: 10px;">¬© 2025 Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        let originalData = [];
        let headers = [];
        let idColumns = new Set();
        let valueColumns = new Set();
        let convertedData = [];
        let convertedHeaders = [];

        // File Upload
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                showNotification('Please upload a CSV or Excel file', 'error');
                return;
            }

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').classList.add('show');
            
            const reader = new FileReader();
            
            if (fileName.endsWith('.csv')) {
                reader.onload = (e) => parseCSV(e.target.result);
                reader.readAsText(file);
            } else {
                reader.onload = (e) => parseExcel(e.target.result);
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            headers = parseCSVLine(lines[0]);
            originalData = lines.slice(1).map(line => parseCSVLine(line));
            
            document.getElementById('fileDetails').textContent = `${originalData.length} rows √ó ${headers.length} columns`;
            showNotification(`Loaded ${originalData.length} rows`, 'success');
            setupColumnSelection();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseExcel(data) {
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            headers = jsonData[0].map(h => String(h || ''));
            originalData = jsonData.slice(1).map(row => 
                headers.map((_, i) => row[i] !== undefined ? String(row[i]) : '')
            );
            
            document.getElementById('fileDetails').textContent = `${originalData.length} rows √ó ${headers.length} columns`;
            showNotification(`Loaded ${originalData.length} rows`, 'success');
            setupColumnSelection();
        }

        function setupColumnSelection() {
            // Show step 2
            document.getElementById('step2Header').classList.remove('hidden');
            document.getElementById('step2Content').classList.remove('hidden');
            
            // Auto-detect: columns with numbers in name likely need unpivoting
            const idPanel = document.getElementById('idColumnsPanel');
            const valuePanel = document.getElementById('valueColumnsPanel');
            idPanel.innerHTML = '';
            valuePanel.innerHTML = '';
            idColumns.clear();
            valueColumns.clear();
            
            headers.forEach((col, idx) => {
                // Check if column name contains a year-like pattern or number suffix
                const hasPattern = /[_\-.]?\d{4}$|[_\-.]?\d{2}$|\d+$/.test(col);
                
                const item = document.createElement('div');
                item.className = 'column-item';
                item.innerHTML = `<input type="checkbox" id="col-${idx}" ${hasPattern ? '' : 'checked'}> <label for="col-${idx}">${col}</label>`;
                item.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                    toggleColumn(idx, col, item.parentElement.id === 'idColumnsPanel');
                };
                
                if (hasPattern) {
                    valueColumns.add(col);
                    valuePanel.appendChild(item);
                } else {
                    idColumns.add(col);
                    idPanel.appendChild(item);
                }
            });
            
            // Add all columns to both panels with proper state
            idPanel.innerHTML = '';
            valuePanel.innerHTML = '';
            
            headers.forEach((col, idx) => {
                const hasPattern = /[_\-.]?\d{4}$|[_\-.]?\d{2}$|\d+$/.test(col);
                
                // ID column item
                const idItem = document.createElement('div');
                idItem.className = 'column-item' + (!hasPattern ? ' selected' : '');
                idItem.innerHTML = `<input type="checkbox" id="id-${idx}" ${!hasPattern ? 'checked' : ''}> <label for="id-${idx}">${col}</label>`;
                idItem.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = idItem.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                    updateColumnSelection();
                };
                idPanel.appendChild(idItem);
                
                // Value column item
                const valItem = document.createElement('div');
                valItem.className = 'column-item' + (hasPattern ? ' selected' : '');
                valItem.innerHTML = `<input type="checkbox" id="val-${idx}" ${hasPattern ? 'checked' : ''}> <label for="val-${idx}">${col}</label>`;
                valItem.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = valItem.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                    updateColumnSelection();
                };
                valuePanel.appendChild(valItem);
            });
            
            updateColumnSelection();
            
            // Show step 3
            document.getElementById('step3Header').classList.remove('hidden');
            document.getElementById('step3Content').classList.remove('hidden');
            
            // Auto-detect separator
            autoDetectSeparator();
            updatePatternPreview();
        }

        function updateColumnSelection() {
            idColumns.clear();
            valueColumns.clear();
            
            document.querySelectorAll('#idColumnsPanel input:checked').forEach(cb => {
                const idx = parseInt(cb.id.split('-')[1]);
                idColumns.add(headers[idx]);
                document.querySelector(`#idColumnsPanel .column-item:nth-child(${idx + 1})`).classList.add('selected');
            });
            document.querySelectorAll('#idColumnsPanel input:not(:checked)').forEach(cb => {
                const idx = parseInt(cb.id.split('-')[1]);
                document.querySelector(`#idColumnsPanel .column-item:nth-child(${idx + 1})`).classList.remove('selected');
            });
            
            document.querySelectorAll('#valueColumnsPanel input:checked').forEach(cb => {
                const idx = parseInt(cb.id.split('-')[1]);
                valueColumns.add(headers[idx]);
                document.querySelector(`#valueColumnsPanel .column-item:nth-child(${idx + 1})`).classList.add('selected');
            });
            document.querySelectorAll('#valueColumnsPanel input:not(:checked)').forEach(cb => {
                const idx = parseInt(cb.id.split('-')[1]);
                document.querySelector(`#valueColumnsPanel .column-item:nth-child(${idx + 1})`).classList.remove('selected');
            });
            
            document.getElementById('idCount').textContent = idColumns.size;
            document.getElementById('valueCount').textContent = valueColumns.size;
            
            updatePatternPreview();
        }

        function selectAllId() {
            document.querySelectorAll('#idColumnsPanel input').forEach(cb => cb.checked = true);
            updateColumnSelection();
        }

        function clearAllId() {
            document.querySelectorAll('#idColumnsPanel input').forEach(cb => cb.checked = false);
            updateColumnSelection();
        }

        function selectAllValue() {
            document.querySelectorAll('#valueColumnsPanel input').forEach(cb => cb.checked = true);
            updateColumnSelection();
        }

        function clearAllValue() {
            document.querySelectorAll('#valueColumnsPanel input').forEach(cb => cb.checked = false);
            updateColumnSelection();
        }

        function autoDetectSeparator() {
            const sampleCols = Array.from(valueColumns).slice(0, 5);
            if (sampleCols.length === 0) return;
            
            const sample = sampleCols[0];
            
            if (sample.includes('_')) {
                document.getElementById('separatorType').value = '_';
            } else if (sample.includes('-')) {
                document.getElementById('separatorType').value = '-';
            } else if (sample.includes('.')) {
                document.getElementById('separatorType').value = '.';
            } else if (/[a-zA-Z]+\d+/.test(sample)) {
                document.getElementById('separatorType').value = 'number';
            }
        }

        function updatePatternPreview() {
            const sepType = document.getElementById('separatorType').value;
            const customSepGroup = document.getElementById('customSepGroup');
            
            if (sepType === 'custom') {
                customSepGroup.classList.remove('hidden');
            } else {
                customSepGroup.classList.add('hidden');
            }
            
            const firstPart = document.getElementById('firstPartName').value || 'indicator';
            const secondPart = document.getElementById('secondPartName').value || 'year';
            const valueName = document.getElementById('valueColName').value || 'value';
            
            // Get sample column
            const sampleCol = Array.from(valueColumns)[0] || 'pop_2023';
            const parts = splitColumnName(sampleCol);
            
            const example = document.getElementById('patternExample');
            example.innerHTML = `
                <strong>Example transformation:</strong><br><br>
                Column: <span class="highlight">${sampleCol}</span> <span class="arrow">‚Üí</span><br>
                <span class="highlight">${firstPart}</span>: ${parts.first}, 
                <span class="highlight">${secondPart}</span>: ${parts.second}, 
                <span class="highlight">${valueName}</span>: [data value]
            `;
        }

        function splitColumnName(colName) {
            const sepType = document.getElementById('separatorType').value;
            let separator;
            
            if (sepType === 'custom') {
                separator = document.getElementById('customSeparator').value || '_';
            } else if (sepType === 'number') {
                // Split at first digit
                const match = colName.match(/^([a-zA-Z_\-]+)(\d+.*)$/);
                if (match) {
                    return { first: match[1], second: match[2] };
                }
                return { first: colName, second: '' };
            } else {
                separator = sepType;
            }
            
            const idx = colName.lastIndexOf(separator);
            if (idx > 0) {
                return { first: colName.substring(0, idx), second: colName.substring(idx + 1) };
            }
            return { first: colName, second: '' };
        }

        function previewConversion() {
            if (valueColumns.size === 0) {
                showNotification('Please select at least one column to unpivot', 'error');
                return;
            }
            
            const firstPartName = document.getElementById('firstPartName').value || 'indicator';
            const secondPartName = document.getElementById('secondPartName').value || 'year';
            const valueColName = document.getElementById('valueColName').value || 'value';
            
            // Build converted data
            convertedData = [];
            const idColArray = Array.from(idColumns);
            const valueColArray = Array.from(valueColumns);
            
            // New headers: ID columns + first part + second part + value
            convertedHeaders = [...idColArray, firstPartName, secondPartName, valueColName];
            
            originalData.forEach(row => {
                // Get ID values
                const idValues = idColArray.map(col => {
                    const idx = headers.indexOf(col);
                    return row[idx] || '';
                });
                
                // For each value column, create a new row
                valueColArray.forEach(col => {
                    const parts = splitColumnName(col);
                    const valueIdx = headers.indexOf(col);
                    const value = row[valueIdx] || '';
                    
                    convertedData.push([...idValues, parts.first, parts.second, value]);
                });
            });
            
            // Show step 4
            document.getElementById('step4Header').classList.remove('hidden');
            document.getElementById('step4Content').classList.remove('hidden');
            
            // Update stats
            document.getElementById('statRows').textContent = convertedData.length.toLocaleString();
            document.getElementById('statCols').textContent = convertedHeaders.length;
            document.getElementById('statExpansion').textContent = (convertedData.length / originalData.length).toFixed(1) + 'x';
            
            // Build preview table (first 20 rows)
            const table = document.getElementById('previewTable');
            let html = '<thead><tr>';
            convertedHeaders.forEach((h, i) => {
                const isNew = i >= idColArray.length;
                html += `<th class="${isNew ? 'new-col' : ''}">${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            const previewRows = convertedData.slice(0, 20);
            previewRows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, i) => {
                    const isNew = i >= idColArray.length;
                    html += `<td class="${isNew ? 'new-col' : ''}">${cell}</td>`;
                });
                html += '</tr>';
            });
            
            if (convertedData.length > 20) {
                html += `<tr><td colspan="${convertedHeaders.length}" style="text-align:center;color:#666;font-style:italic;">... and ${convertedData.length - 20} more rows</td></tr>`;
            }
            
            html += '</tbody>';
            table.innerHTML = html;
            
            showNotification(`Conversion preview ready: ${convertedData.length} rows`, 'success');
            
            // Scroll to preview
            document.getElementById('step4Header').scrollIntoView({ behavior: 'smooth' });
        }

        function downloadResult(format) {
            if (convertedData.length === 0) {
                showNotification('No data to download. Please run the conversion first.', 'error');
                return;
            }
            
            if (format === 'csv') {
                let csv = convertedHeaders.map(h => `"${h}"`).join(',') + '\n';
                convertedData.forEach(row => {
                    csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                downloadBlob(blob, 'long_format_data.csv');
            } else {
                const wb = XLSX.utils.book_new();
                const wsData = [convertedHeaders, ...convertedData];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Long Format');
                XLSX.writeFile(wb, 'long_format_data.xlsx');
            }
            
            showNotification(`Downloaded as ${format.toUpperCase()}`, 'success');
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            setTimeout(() => { notification.className = 'notification'; }, 4000);
        }
    </script>
</body>
</html>
